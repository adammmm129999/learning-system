<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è¨è«–å€ï¼ˆé•·è€…å‹å–„ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #f9f9f9;
      color: #333;
      font-size: 20px;
      line-height: 1.8;
      margin: 0;
      padding: 0;
    }
    h1 {
      font-size: 28px;
      color: #004080;
      text-align: center;
      margin: 30px 0;
    }
    .navbar {
      background-color: #4a90e2;
      padding: 20px 0;
    }
    .navbar .container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-size: 22px;
      padding: 10px 20px;
      background-color: #357abd;
      border-radius: 12px;
      margin: 5px;
    }
    .navbar a:hover {
      background-color: #285c9f;
    }
    .comment {
      background-color: #fff;
      border: 2px solid #ccc;
      border-radius: 12px;
      padding: 20px;
      margin: 15px;
    }
    .reply {
      margin-left: 40px;
      border-left: 4px solid #aaccee;
      padding-left: 15px;
      margin-top: 10px;
    }
    .comment b, .reply b {
      color: #006699;
      font-size: 22px;
    }
    textarea, input[type="text"] {
      font-size: 18px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #999;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    textarea {
      height: 100px;
      resize: none;
    }
    button {
      font-size: 20px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      margin-top: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background-color: #a71d2a;
    }
    .instruction {
      font-size: 18px;
      color: #555;
      text-align: center;
    }
    .button-container {
      text-align: center;
      margin-top: 10px;
    }
    .reply-box {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar">
    <div class="container">
      <a href="home.html">ğŸ  é¦–é </a>
      <a href="course.html">ğŸ“˜ èª²ç¨‹æ•™å­¸</a>
      <a href="introduce.html">ğŸ’» è¨­å‚™ä»‹ç´¹</a>
      <a href="discussion.html">ğŸ’¬ è¨è«–å€</a>
      <a href="progress.html">ğŸ“ˆ å­¸ç¿’é€²åº¦</a>
      <a href="personal_account.html">å€‹äººè³‡æ–™ğŸ“„</a>
      <a href="logout.php">ğŸ”“ ç™»å‡º</a>
     
    </div>
  </nav>

  <h1>ç•™è¨€è¨è«–å€</h1>
  <p class="instruction">è«‹è¼¸å…¥æ‚¨çš„ç•™è¨€ï¼Œæˆ–å›è¦†ä»–äººçš„ç•™è¨€ã€‚</p>

  <div id="commentSection">è¼‰å…¥ç•™è¨€ä¸­...</div>

  <h2>æ–°å¢ç•™è¨€</h2>
  <textarea id="newComment" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç•™è¨€å…§å®¹..."></textarea><br>
  <div class="button-container">
    <button onclick="postComment()">é€å‡ºç•™è¨€</button>
  </div>

<script>
let currentUserId = null;

function escapeHtml(text) {
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
}

function loadComments() {
  fetch('load_comments.php')
    .then(res => res.json())
    .then(data => {
      const section = document.getElementById('commentSection');
      if (!data.success) {
        section.innerHTML = '<p>è¼‰å…¥ç•™è¨€å¤±æ•—</p>';
        return;
      }

      currentUserId = data.current_user_id;
      section.innerHTML = '';
      if (data.comments.length === 0) {
        section.innerHTML = '<p>ç›®å‰é‚„æ²’æœ‰ç•™è¨€ï¼Œæ­¡è¿æ¶å…ˆç•™è¨€ï¼</p>';
        return;
      }

      data.comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment';

        div.innerHTML = `
          <p><b>${escapeHtml(c.username)}</b> èªªï¼š</p>
          <p>${escapeHtml(c.content)}</p>
          <small>${c.created_at}</small>
        `;

        if (c.user_id === currentUserId) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'åˆªé™¤ç•™è¨€';
          delBtn.onclick = () => deleteComment(c.id);
          div.appendChild(delBtn);
        }

        if (c.replies) {
          c.replies.forEach(r => {
            const replyDiv = document.createElement('div');
            replyDiv.className = 'reply';
            replyDiv.innerHTML = `
              <p><b>${escapeHtml(r.username)}</b> å›è¦†ï¼š</p>
              <p>${escapeHtml(r.content)}</p>
              <small>${r.created_at}</small>
            `;

            if (r.user_id === currentUserId) {
              const delReplyBtn = document.createElement('button');
              delReplyBtn.className = 'delete-btn';
              delReplyBtn.textContent = 'åˆªé™¤å›è¦†';
              delReplyBtn.onclick = () => deleteReply(r.id);
              replyDiv.appendChild(delReplyBtn);
            }

            div.appendChild(replyDiv);
          });
        }

        const replyBox = document.createElement('div');
        replyBox.className = 'reply-box';
        replyBox.innerHTML = `
          <textarea id="replyInput_${c.id}" placeholder="å›è¦† ${escapeHtml(c.username)} çš„ç•™è¨€..." rows="2"></textarea><br>
          <button onclick="postReply(${c.id})">é€å‡ºå›è¦†</button>
        `;
        div.appendChild(replyBox);

        section.appendChild(div);
      });
    })
    .catch(err => {
      console.error(err);
      document.getElementById('commentSection').innerHTML = '<p>è¼‰å…¥ç•™è¨€ç™¼ç”ŸéŒ¯èª¤</p>';
    });
}

function postComment() {
  const text = document.getElementById('newComment').value.trim();
  if (!text) return alert('ç•™è¨€å…§å®¹ä¸å¯ç‚ºç©º');
  fetch('post_comment.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ comment: text })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.getElementById('newComment').value = '';
      loadComments();
    } else {
      alert('ç•™è¨€å¤±æ•—ï¼š' + data.message);
    }
  });
}

function postReply(commentId) {
  const input = document.getElementById(`replyInput_${commentId}`);
  const text = input.value.trim();
  if (!text) return alert('å›è¦†å…§å®¹ä¸å¯ç‚ºç©º');
  fetch('post_reply.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ comment_id: commentId, reply: text })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      input.value = '';
      loadComments();
    } else {
      alert('å›è¦†å¤±æ•—ï¼š' + data.message);
    }
  });
}

function deleteComment(commentId) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')) return;
  fetch('delete_comment.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ comment_id: commentId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) loadComments();
    else alert('åˆªé™¤å¤±æ•—ï¼š' + data.message);
  });
}

function deleteReply(replyId) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å›è¦†å—ï¼Ÿ')) return;
  fetch('delete_reply.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reply_id: replyId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) loadComments();
    else alert('åˆªé™¤å¤±æ•—ï¼š' + data.message);
  });
}

// åˆå§‹åŒ–
loadComments();

// æ¯15ç§’è‡ªå‹•åˆ·æ–°ç•™è¨€å€
setInterval(loadComments, 15000);
</script>
</body>
</html>
