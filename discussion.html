<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>討論區</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f2f2f2; }
    .comment, .reply { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .reply { margin-left: 30px; background-color: #eef; }
    textarea { width: 100%; padding: 5px; margin-top: 5px; }
    button { margin-top: 5px; }
    .delete-btn { color: red; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>留言討論區</h1>
  <button onclick="logout()">登出</button>
  <hr>
  
  <div>
    <h3>我要留言：</h3>
    <textarea id="newComment" placeholder="輸入留言內容..."></textarea>
    <button onclick="postComment()">送出留言</button>
  </div>
  <hr>
  
  <div id="commentSection"></div>

  <!-- Firebase SDK 模組 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      deleteDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // ✅ 請在此輸入你自己的 Firebase 設定
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("請先登入");
        window.location.href = "index.html";
      } else {
        currentUser = user;
        loadComments();
      }
    });

    async function postComment() {
      const content = document.getElementById("newComment").value.trim();
      if (!content) return alert("請輸入留言內容");
      await addDoc(collection(db, "comments"), {
        content: content,
        userId: currentUser.uid,
        username: currentUser.email,
        createdAt: serverTimestamp()
      });
      document.getElementById("newComment").value = "";
      loadComments();
    }

    async function loadComments() {
      const section = document.getElementById("commentSection");
      section.innerHTML = "";
      const q = query(collection(db, "comments"), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);

      for (const docSnap of snapshot.docs) {
        const c = docSnap.data();
        const commentId = docSnap.id;

        const div = document.createElement("div");
        div.className = "comment";
        div.innerHTML = `
          <p><strong>${c.username}</strong> 說：</p>
          <p>${c.content}</p>
          <small>${c.createdAt?.toDate().toLocaleString() || ''}</small>
        `;

        if (c.userId === currentUser.uid) {
          const delBtn = document.createElement("button");
          delBtn.className = "delete-btn";
          delBtn.textContent = "刪除留言";
          delBtn.onclick = () => deleteComment(commentId);
          div.appendChild(delBtn);
        }

        // 載入回覆
        const repliesRef = collection(db, "comments", commentId, "replies");
        const repliesSnap = await getDocs(query(repliesRef, orderBy("createdAt", "asc")));

        repliesSnap.forEach(replyDoc => {
          const r = replyDoc.data();
          const replyDiv = document.createElement("div");
          replyDiv.className = "reply";
          replyDiv.innerHTML = `
            <p><strong>${r.username}</strong> 回覆：</p>
            <p>${r.content}</p>
            <small>${r.createdAt?.toDate().toLocaleString() || ''}</small>
          `;
          if (r.userId === currentUser.uid) {
            const delReplyBtn = document.createElement("button");
            delReplyBtn.className = "delete-btn";
            delReplyBtn.textContent = "刪除回覆";
            delReplyBtn.onclick = () => deleteReply(commentId, replyDoc.id);
            replyDiv.appendChild(delReplyBtn);
          }
          div.appendChild(replyDiv);
        });

        // 回覆輸入區
        const replyBox = document.createElement("div");
        replyBox.className = "reply-box";
        replyBox.innerHTML = `
          <textarea id="replyInput_${commentId}" placeholder="回覆這則留言..."></textarea>
          <button onclick="postReply('${commentId}')">送出回覆</button>
        `;
        div.appendChild(replyBox);
        section.appendChild(div);
      }
    }

    async function postReply(commentId) {
      const input = document.getElementById(`replyInput_${commentId}`);
      const content = input.value.trim();
      if (!content) return alert("請輸入回覆內容");
      const replyRef = collection(db, "comments", commentId, "replies");
      await addDoc(replyRef, {
        content: content,
        userId: currentUser.uid,
        username: currentUser.email,
        createdAt: serverTimestamp()
      });
      input.value = "";
      loadComments();
    }

    async function deleteComment(commentId) {
      if (confirm("確定刪除這則留言？")) {
        await deleteDoc(doc(db, "comments", commentId));
        loadComments();
      }
    }

    async function deleteReply(commentId, replyId) {
      if (confirm("確定刪除這則回覆？")) {
        await deleteDoc(doc(db, "comments", commentId, "replies", replyId));
        loadComments();
      }
    }

    async function logout() {
      await signOut(auth);
      alert("已登出");
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
