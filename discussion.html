<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è¨è«–å€</title>
  <style>
     body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 0;
      background-color: #fefefe;
      color: #333;
    }

    /* å°è¦½åˆ—ç¶­æŒåŸæœ¬è¨­å®š */
.navbar {
  background-color: #4a90e2;
  padding: 16px;
  text-align: center;
  z-index: 10;
}

/* å°è¦½åˆ—æ–‡å­—é¡è‰² */
.navbar a {
  color: white;
  text-decoration: none;
  margin: 0 12px;
  font-size: 20px;
}
    .comment, .reply { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .reply { margin-left: 30px; background-color: #eef; }
    textarea { width: 100%; padding: 5px; margin-top: 5px; }
    button { margin-top: 5px; }
    .delete-btn { color: red; margin-left: 10px; }
  </style>
</head>
<body>
   <nav class="navbar">
    <div class="container">
      <a href="home.html">ğŸ  é¦–é </a>
      <a href="course.html">ğŸ“˜ èª²ç¨‹æ•™å­¸</a>
      <a href="discussion.html">ğŸ’¬ è¨è«–å€</a>    
      <a href="personal_account.html">å€‹äººè³‡æ–™ğŸ“„</a>
      <button id="logoutBtn">ğŸ”“ ç™»å‡º</button>
    </div>
  </nav>
  <h1>ç•™è¨€è¨è«–å€</h1>
  <button onclick="logout()">ç™»å‡º</button>
  <hr>
  
  <div>
    <h3>æˆ‘è¦ç•™è¨€ï¼š</h3>
    <textarea id="newComment" placeholder="è¼¸å…¥ç•™è¨€å…§å®¹..."></textarea>
    <button onclick="postComment()">é€å‡ºç•™è¨€</button>
  </div>
  <hr>
  
  <div id="commentSection"></div>

  <!-- Firebase SDK æ¨¡çµ„ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      deleteDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // âœ… è«‹åœ¨æ­¤è¼¸å…¥ä½ è‡ªå·±çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("è«‹å…ˆç™»å…¥");
        window.location.href = "index.html";
      } else {
        currentUser = user;
        loadComments();
      }
    });

    async function postComment() {
      const content = document.getElementById("newComment").value.trim();
      if (!content) return alert("è«‹è¼¸å…¥ç•™è¨€å…§å®¹");
      await addDoc(collection(db, "comments"), {
        content: content,
        userId: currentUser.uid,
        username: currentUser.email,
        createdAt: serverTimestamp()
      });
      document.getElementById("newComment").value = "";
      loadComments();
    }

    async function loadComments() {
      const section = document.getElementById("commentSection");
      section.innerHTML = "";
      const q = query(collection(db, "comments"), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);

      for (const docSnap of snapshot.docs) {
        const c = docSnap.data();
        const commentId = docSnap.id;

        const div = document.createElement("div");
        div.className = "comment";
        div.innerHTML = `
          <p><strong>${c.username}</strong> èªªï¼š</p>
          <p>${c.content}</p>
          <small>${c.createdAt?.toDate().toLocaleString() || ''}</small>
        `;

        if (c.userId === currentUser.uid) {
          const delBtn = document.createElement("button");
          delBtn.className = "delete-btn";
          delBtn.textContent = "åˆªé™¤ç•™è¨€";
          delBtn.onclick = () => deleteComment(commentId);
          div.appendChild(delBtn);
        }

        // è¼‰å…¥å›è¦†
        const repliesRef = collection(db, "comments", commentId, "replies");
        const repliesSnap = await getDocs(query(repliesRef, orderBy("createdAt", "asc")));

        repliesSnap.forEach(replyDoc => {
          const r = replyDoc.data();
          const replyDiv = document.createElement("div");
          replyDiv.className = "reply";
          replyDiv.innerHTML = `
            <p><strong>${r.username}</strong> å›è¦†ï¼š</p>
            <p>${r.content}</p>
            <small>${r.createdAt?.toDate().toLocaleString() || ''}</small>
          `;
          if (r.userId === currentUser.uid) {
            const delReplyBtn = document.createElement("button");
            delReplyBtn.className = "delete-btn";
            delReplyBtn.textContent = "åˆªé™¤å›è¦†";
            delReplyBtn.onclick = () => deleteReply(commentId, replyDoc.id);
            replyDiv.appendChild(delReplyBtn);
          }
          div.appendChild(replyDiv);
        });

        // å›è¦†è¼¸å…¥å€
        const replyBox = document.createElement("div");
        replyBox.className = "reply-box";
        replyBox.innerHTML = `
          <textarea id="replyInput_${commentId}" placeholder="å›è¦†é€™å‰‡ç•™è¨€..."></textarea>
          <button onclick="postReply('${commentId}')">é€å‡ºå›è¦†</button>
        `;
        div.appendChild(replyBox);
        section.appendChild(div);
      }
    }

    async function postReply(commentId) {
      const input = document.getElementById(`replyInput_${commentId}`);
      const content = input.value.trim();
      if (!content) return alert("è«‹è¼¸å…¥å›è¦†å…§å®¹");
      const replyRef = collection(db, "comments", commentId, "replies");
      await addDoc(replyRef, {
        content: content,
        userId: currentUser.uid,
        username: currentUser.email,
        createdAt: serverTimestamp()
      });
      input.value = "";
      loadComments();
    }

    async function deleteComment(commentId) {
      if (confirm("ç¢ºå®šåˆªé™¤é€™å‰‡ç•™è¨€ï¼Ÿ")) {
        await deleteDoc(doc(db, "comments", commentId));
        loadComments();
      }
    }

    async function deleteReply(commentId, replyId) {
      if (confirm("ç¢ºå®šåˆªé™¤é€™å‰‡å›è¦†ï¼Ÿ")) {
        await deleteDoc(doc(db, "comments", commentId, "replies", replyId));
        loadComments();
      }
    }

    async function logout() {
      await signOut(auth);
      alert("å·²ç™»å‡º");
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
