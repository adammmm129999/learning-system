<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å€‹äººå­¸ç¿’ç´€éŒ„</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 0;
      background-color: #fefefe;
      color: #333;
    }

    .navbar {
      background-color: #4a90e2;
      padding: 24px 16px;
      text-align: center;
      font-size: 40px;
    }

    .navbar a {
      color: white;
      text-decoration: none;
      margin: 0 24px;
      font-size: 40px;
    }

    .background-section {
      background-color: #e3f2fd;
      min-height: 40vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #333;
      padding: 40px 20px;
    }

    .background-section h1 {
      font-size: 48px;
      margin: 0;
    }

    h1 {
      font-size: 56px; /* æŠŠã€Œæˆ‘çš„å­¸ç¿’ç´€éŒ„ã€æ¨™é¡Œå­—é«”æ”¾å¤§ */
      text-align: center;
      margin: 32px 0;
      color: #333;
    }
    #logoutBtn {
      font-size: 24px;
      padding: 8px 16px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      margin-left: 20px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background-color: #d32f2f;
    }

    .course-status {
      background: #eef6fc;
      padding: 30px 40px; /* å…§è·åŠ å¤§ */
      margin: 24px auto;  /* ä¸Šä¸‹é–“è·åŠ å¤§ï¼Œå·¦å³ç½®ä¸­ */
      border-radius: 12px;
      box-shadow: 1px 1px 8px rgba(0,0,0,0.15);
      max-width: 900px;   /* ç‰ˆé¢åŠ å¯¬ */
      font-size: 32px;    /* æ–‡å­—æ”¾å¤§ï¼Œè®“é•·è€…æ˜“è®€ */
      line-height: 1.6;
      color: #333;
      word-break: break-word;
    }

    .completed {
      color: green;
      font-weight: bold;
      font-size: 26px; /* å‹¾é¸ç‹€æ…‹å­—é«”ä¹Ÿç¨å¾®æ”¾å¤§ */
    }

    .not-completed {
      color: #999;
      font-weight: normal;
      font-size: 24px;
    }

    ul {
      margin: 12px 0 0 20px;
      padding: 0;
      list-style-type: disc;
    }

    li {
      margin-bottom: 12px;
      font-size: 22px; /* æ¯ç­†ç´€éŒ„å­—é«”åŠ å¤§ */
    }

    #logoutBtn:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <!-- å°è¦½åˆ— -->
  <nav class="navbar">
    <div class="container">
      <a href="home.html">ğŸ  é¦–é </a>
      <a href="course.html">ğŸ“˜ èª²ç¨‹æ•™å­¸</a>
      <a href="discussion.html">ğŸ’¬ è¨è«–å€</a>
      <a href="personal_account.html">ğŸ“„å­¸ç¿’ç´€éŒ„</a>
      <button id="logoutBtn">ğŸ”“ ç™»å‡º</button>
    </div>
  </nav>

  <h1>æˆ‘çš„å­¸ç¿’ç´€éŒ„</h1>

  <div id="course1" class="course-status">è¼‰å…¥èª²ç¨‹ä¸€ç´€éŒ„ä¸­...</div>
  <div id="course2" class="course-status">è¼‰å…¥èª²ç¨‹äºŒç´€éŒ„ä¸­...</div>
  <div style="text-align: center; margin-top: 24px;">
  <button id="clearLogsBtn" style="
    font-size: 24px;
    padding: 10px 20px;
    background-color: #e53935;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  ">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0VF7SkuXvOAJyuC-2tPl_KGris3f4gqE",
    authDomain: "final-project-fb104.firebaseapp.com",
    projectId: "final-project-fb104",
    appId: "1:150740541108:web:1a0dba9ebb4cbb157001e1",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const course1Div = document.getElementById("course1");
  const course2Div = document.getElementById("course2");
  const logoutBtn = document.getElementById("logoutBtn");
  const clearLogsBtn = document.getElementById("clearLogsBtn");

  let currentUser = null; // âœ… å®£å‘Š user ç‚ºå…¨åŸŸè®Šæ•¸

  logoutBtn.addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        alert("å·²ç™»å‡º");
        window.location.href = "index.html";
      })
      .catch(error => alert("ç™»å‡ºå¤±æ•—ï¼š" + error.message));
  });

  // âœ… è®€å–èª²ç¨‹ç´€éŒ„å‡½å¼ï¼ˆå®šç¾©åœ¨å¤–éƒ¨å¯é‡è¤‡ä½¿ç”¨ï¼‰
  async function loadCourseLogs(courseId, targetDiv) {
    const logsRef = collection(db, "users", currentUser.uid, "courseLogs", courseId, "logs");
    const logsQuery = query(logsRef, orderBy("timestamp", "desc"));
    const logsSnap = await getDocs(logsQuery);

    if (logsSnap.empty) {
      targetDiv.innerHTML = `<span class="not-completed">âœ˜ å°šç„¡ ${courseId} çš„å­¸ç¿’ç´€éŒ„</span>`;
    } else {
      let html = `<span class="completed">âœ” ${courseId} å­¸ç¿’ç´€éŒ„ï¼š</span><ul>`;
      logsSnap.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() : "æœªè¨˜éŒ„æ™‚é–“";
        const note = data.detail || "æœªå¡«å¯«å‚™è¨»";
        html += `<li>${time}ï¼ˆ${note}ï¼‰</li>`;
      });
      html += `</ul>`;
      targetDiv.innerHTML = html;
    }
  }

  // âœ… Firebase ç™»å…¥ç‹€æ…‹ç›£è½
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("è«‹å…ˆç™»å…¥");
      window.location.href = "login.html";
      return;
    }

    currentUser = user; // âœ… å„²å­˜ user ä»¥ä¾¿å…¶ä»–åœ°æ–¹ä½¿ç”¨

    await loadCourseLogs("course1", course1Div);
    await loadCourseLogs("course2", course2Div);
  });

  // âœ… æ¸…é™¤æ‰€æœ‰èª²ç¨‹ç´€éŒ„æŒ‰éˆ•
  clearLogsBtn.addEventListener("click", async () => {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰èª²ç¨‹ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚")) return;

    try {
      async function deleteLogs(courseId) {
        const logsRef = collection(db, "users", currentUser.uid, "courseLogs", courseId, "logs");
        const logsSnap = await getDocs(logsRef);
        const deletions = logsSnap.docs.map(docSnap =>
          deleteDoc(doc(db, "users", currentUser.uid, "courseLogs", courseId, "logs", docSnap.id))
        );
        await Promise.all(deletions);
      }

      await deleteLogs("course1");
      await deleteLogs("course2");

      await loadCourseLogs("course1", course1Div);
      await loadCourseLogs("course2", course2Div);

      alert("å·²æˆåŠŸåˆªé™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„");
    } catch (error) {
      alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
    }
  });
</script>


</body>
</html>
