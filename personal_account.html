<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>個人學習紀錄</title>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 0;
      background-color: #fefefe;
      color: #333;
    }

    .navbar {
      background-color: #4a90e2;
      padding: 24px 16px;
      text-align: center;
      font-size: 40px;
    }

    .navbar a {
      color: white;
      text-decoration: none;
      margin: 0 24px;
      font-size: 40px;
    }

    .background-section {
      background-color: #e3f2fd;
      min-height: 40vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #333;
      padding: 40px 20px;
    }

    .background-section h1 {
      font-size: 48px;
      margin: 0;
    }

    h1 {
      font-size: 56px; /* 把「我的學習紀錄」標題字體放大 */
      text-align: center;
      margin: 32px 0;
      color: #333;
    }
    #logoutBtn {
      font-size: 24px;
      padding: 8px 16px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      margin-left: 20px;
      cursor: pointer;
    }

    #logoutBtn:hover {
      background-color: #d32f2f;
    }

    .course-status {
      background: #eef6fc;
      padding: 30px 40px; /* 內距加大 */
      margin: 24px auto;  /* 上下間距加大，左右置中 */
      border-radius: 12px;
      box-shadow: 1px 1px 8px rgba(0,0,0,0.15);
      max-width: 900px;   /* 版面加寬 */
      font-size: 32px;    /* 文字放大，讓長者易讀 */
      line-height: 1.6;
      color: #333;
      word-break: break-word;
    }

    .completed {
      color: green;
      font-weight: bold;
      font-size: 26px; /* 勾選狀態字體也稍微放大 */
    }

    .not-completed {
      color: #999;
      font-weight: normal;
      font-size: 24px;
    }

    ul {
      margin: 12px 0 0 20px;
      padding: 0;
      list-style-type: disc;
    }

    li {
      margin-bottom: 12px;
      font-size: 22px; /* 每筆紀錄字體加大 */
    }

    #logoutBtn:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <!-- 導覽列 -->
  <nav class="navbar">
    <div class="container">
      <a href="home.html">🏠 首頁</a>
      <a href="course.html">📘 課程教學</a>
      <a href="discussion.html">💬 討論區</a>
      <a href="personal_account.html">📄學習紀錄</a>
      <button id="logoutBtn">🔓 登出</button>
    </div>
  </nav>

  <h1>我的學習紀錄</h1>

  <div id="course1" class="course-status">載入課程一紀錄中...</div>
  <div id="course2" class="course-status">載入課程二紀錄中...</div>
  <div style="text-align: center; margin-top: 24px;">
  <button id="clearLogsBtn" style="
    font-size: 24px;
    padding: 10px 20px;
    background-color: #e53935;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  ">🗑️ 清除所有學習紀錄</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0VF7SkuXvOAJyuC-2tPl_KGris3f4gqE",
    authDomain: "final-project-fb104.firebaseapp.com",
    projectId: "final-project-fb104",
    appId: "1:150740541108:web:1a0dba9ebb4cbb157001e1",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const course1Div = document.getElementById("course1");
  const course2Div = document.getElementById("course2");
  const logoutBtn = document.getElementById("logoutBtn");
  const clearLogsBtn = document.getElementById("clearLogsBtn");

  let currentUser = null; // ✅ 宣告 user 為全域變數

  logoutBtn.addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        alert("已登出");
        window.location.href = "index.html";
      })
      .catch(error => alert("登出失敗：" + error.message));
  });

  // ✅ 讀取課程紀錄函式（定義在外部可重複使用）
  async function loadCourseLogs(courseId, targetDiv) {
    const logsRef = collection(db, "users", currentUser.uid, "courseLogs", courseId, "logs");
    const logsQuery = query(logsRef, orderBy("timestamp", "desc"));
    const logsSnap = await getDocs(logsQuery);

    if (logsSnap.empty) {
      targetDiv.innerHTML = `<span class="not-completed">✘ 尚無 ${courseId} 的學習紀錄</span>`;
    } else {
      let html = `<span class="completed">✔ ${courseId} 學習紀錄：</span><ul>`;
      logsSnap.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() : "未記錄時間";
        const note = data.detail || "未填寫備註";
        html += `<li>${time}（${note}）</li>`;
      });
      html += `</ul>`;
      targetDiv.innerHTML = html;
    }
  }

  // ✅ Firebase 登入狀態監聽
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("請先登入");
      window.location.href = "login.html";
      return;
    }

    currentUser = user; // ✅ 儲存 user 以便其他地方使用

    await loadCourseLogs("course1", course1Div);
    await loadCourseLogs("course2", course2Div);
  });

  // ✅ 清除所有課程紀錄按鈕
  clearLogsBtn.addEventListener("click", async () => {
    if (!confirm("確定要刪除所有課程紀錄嗎？此動作無法還原。")) return;

    try {
      async function deleteLogs(courseId) {
        const logsRef = collection(db, "users", currentUser.uid, "courseLogs", courseId, "logs");
        const logsSnap = await getDocs(logsRef);
        const deletions = logsSnap.docs.map(docSnap =>
          deleteDoc(doc(db, "users", currentUser.uid, "courseLogs", courseId, "logs", docSnap.id))
        );
        await Promise.all(deletions);
      }

      await deleteLogs("course1");
      await deleteLogs("course2");

      await loadCourseLogs("course1", course1Div);
      await loadCourseLogs("course2", course2Div);

      alert("已成功刪除所有學習紀錄");
    } catch (error) {
      alert("刪除失敗：" + error.message);
    }
  });
</script>


</body>
</html>
